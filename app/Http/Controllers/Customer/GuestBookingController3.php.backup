<?php

declare(strict_types=1);

namespace App\Http\Controllers\Customer;

use App\Http\Controllers\Controller;
use App\Models\Booking;
use App\Models\GuestSession;
use App\Models\Hall;
use App\Models\User;
use App\Models\ExtraService;
use App\Notifications\GuestBookingOtpNotification;
use App\Notifications\GuestBookingConfirmationNotification;
use Illuminate\Http\Request;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Notification;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Str;
use Illuminate\Validation\Rules\Password;
use Illuminate\View\View;
use Carbon\Carbon;
use Exception;

/**
 * Guest Booking Controller
 *
 * Handles all guest booking operations including:
 * - Session creation and OTP verification
 * - Booking form submission with total calculation
 * - Payment processing (Thawani integration)
 * - Account creation after booking
 *
 * This controller is SELF-CONTAINED and does not require
 * external BookingService or PaymentService classes.
 *
 * @package App\Http\Controllers\Customer
 * @version 2.0.0
 */
class GuestBookingController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | STEP 1: Guest Information & OTP
    |--------------------------------------------------------------------------
    */

    /**
     * Show guest booking form (Step 1: Enter guest details).
     *
     * @param Hall $hall
     * @return View
     */
    public function create(Hall $hall): View
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);
        session(['locale' => $locale]);

        // Check if hall is active and available for booking
        if (!$hall->is_active) {
            abort(404, __('halls.not_available'));
        }

        return view('customer.guest.book', compact('hall'));
    }

    /**
     * Initiate guest booking and send OTP.
     *
     * @param Request $request
     * @param Hall $hall
     * @return RedirectResponse
     */
    public function initiate(Request $request, Hall $hall): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Validate guest information
        $validator = Validator::make($request->all(), [
            'name' => ['required', 'string', 'min:2', 'max:255'],
            'email' => ['required', 'email', 'max:255'],
            'phone' => ['required', 'string', 'min:8', 'max:20'],
        ], [
            'name.required' => __('guest.name_required') !== 'guest.name_required' ? __('guest.name_required') : 'Name is required.',
            'email.required' => __('guest.email_required') !== 'guest.email_required' ? __('guest.email_required') : 'Email is required.',
            'email.email' => __('guest.email_invalid') !== 'guest.email_invalid' ? __('guest.email_invalid') : 'Please enter a valid email.',
            'phone.required' => __('guest.phone_required') !== 'guest.phone_required' ? __('guest.phone_required') : 'Phone is required.',
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator)->withInput();
        }

        $email = strtolower(trim($request->input('email')));
        $name = trim($request->input('name'));
        $phone = trim($request->input('phone'));

        // Check if email belongs to a registered user
        if (User::where('email', $email)->exists()) {
            return back()
                ->with('email_registered', true)
                ->with('registered_email', $email)
                ->withInput();
        }

        // Check pending sessions limit (max 3 per email)
        $pendingCount = GuestSession::where('email', $email)
            ->where('status', 'pending')
            ->where('expires_at', '>', now())
            ->count();

        if ($pendingCount >= 3) {
            return back()
                ->with('error', __('guest.too_many_pending_sessions') !== 'guest.too_many_pending_sessions' 
                    ? __('guest.too_many_pending_sessions') 
                    : 'Too many pending sessions. Please try again later.')
                ->withInput();
        }

        try {
            // Create guest session
            $guestSession = GuestSession::create([
                'session_token' => Str::uuid()->toString(),
                'email' => $email,
                'phone' => $phone,
                'name' => $name,
                'hall_id' => $hall->id,
                'otp_code' => $this->generateOtp(),
                'otp_expires_at' => now()->addMinutes(10),
                'otp_attempts' => 0,
                'is_verified' => false,
                'status' => 'pending',
                'ip_address' => $request->ip(),
                'user_agent' => $request->userAgent(),
                'expires_at' => now()->addHours(24),
            ]);

            // Store session token in browser session
            session(['guest_session_token' => $guestSession->session_token]);

            // Send OTP notification
            Notification::route('mail', $email)
                ->notify(new GuestBookingOtpNotification(
                    $guestSession->otp_code,
                    $name,
                    $hall
                ));

            Log::info('Guest OTP sent', [
                'session_id' => $guestSession->id,
                'email' => $this->maskEmail($email),
                'hall_id' => $hall->id,
            ]);

            return redirect()
                ->route('guest.verify-otp', ['hall' => $hall->slug, 'lang' => $locale])
                ->with('success', __('guest.otp_sent') !== 'guest.otp_sent' ? __('guest.otp_sent') : 'Verification code sent to your email!');

        } catch (Exception $e) {
            Log::error('Failed to initiate guest booking', [
                'error' => $e->getMessage(),
                'email' => $this->maskEmail($email),
            ]);

            return back()
                ->with('error', __('guest.initiation_failed') !== 'guest.initiation_failed' 
                    ? __('guest.initiation_failed') 
                    : 'Failed to send verification code. Please try again.')
                ->withInput();
        }
    }

    /**
     * Show OTP verification page.
     *
     * @param Hall $hall
     * @return View|RedirectResponse
     */
    public function showVerifyOtp(Hall $hall): View|RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $sessionToken = session('guest_session_token');
        $guestSession = GuestSession::where('session_token', $sessionToken)
            ->where('status', 'pending')
            ->first();

        if (!$guestSession) {
            return redirect()
                ->route('guest.book', ['hall' => $hall->slug, 'lang' => $locale])
                ->with('error', __('guest.session_expired') !== 'guest.session_expired' 
                    ? __('guest.session_expired') 
                    : 'Session expired. Please start again.');
        }

        return view('customer.guest.verify-otp', [
            'hall' => $hall,
            'maskedEmail' => $this->maskEmail($guestSession->email),
            'attemptsRemaining' => 3 - $guestSession->otp_attempts,
        ]);
    }

    /**
     * Verify OTP code.
     *
     * @param Request $request
     * @param Hall $hall
     * @return RedirectResponse
     */
    public function verifyOtp(Request $request, Hall $hall): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $validator = Validator::make($request->all(), [
            'otp' => ['required', 'string', 'size:6'],
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator);
        }

        $sessionToken = session('guest_session_token');
        $guestSession = GuestSession::where('session_token', $sessionToken)
            ->where('status', 'pending')
            ->first();

        if (!$guestSession) {
            return redirect()
                ->route('guest.book', ['hall' => $hall->slug, 'lang' => $locale])
                ->with('error', __('guest.session_expired') !== 'guest.session_expired' 
                    ? __('guest.session_expired') 
                    : 'Session expired. Please start again.');
        }

        // Check if OTP is expired
        if ($guestSession->otp_expires_at < now()) {
            return back()->with('error', __('guest.otp_expired') !== 'guest.otp_expired' 
                ? __('guest.otp_expired') 
                : 'Verification code expired. Please request a new one.');
        }

        // Check attempts limit
        if ($guestSession->otp_attempts >= 3) {
            $guestSession->update(['status' => 'expired']);
            return redirect()
                ->route('guest.book', ['hall' => $hall->slug, 'lang' => $locale])
                ->with('error', __('guest.too_many_attempts') !== 'guest.too_many_attempts' 
                    ? __('guest.too_many_attempts') 
                    : 'Too many failed attempts. Please start again.');
        }

        // Verify OTP
        $inputOtp = trim($request->input('otp'));
        if ($guestSession->otp_code !== $inputOtp) {
            $guestSession->increment('otp_attempts');
            $remaining = 3 - $guestSession->otp_attempts;

            return back()->with('error', __('guest.otp_invalid', ['remaining' => $remaining]) !== 'guest.otp_invalid' 
                ? __('guest.otp_invalid', ['remaining' => $remaining]) 
                : "Invalid code. {$remaining} attempts remaining.");
        }

        // OTP verified successfully
        $guestSession->update([
            'is_verified' => true,
            'status' => 'verified',
            'verified_at' => now(),
        ]);

        Log::info('Guest OTP verified', [
            'session_id' => $guestSession->id,
        ]);

        return redirect()
            ->route('guest.booking-form', ['hall' => $hall->slug, 'lang' => $locale])
            ->with('success', __('guest.otp_verified') !== 'guest.otp_verified' 
                ? __('guest.otp_verified') 
                : 'Email verified! Please complete your booking.');
    }

    /**
     * Resend OTP code.
     *
     * @param Request $request
     * @param Hall $hall
     * @return RedirectResponse
     */
    public function resendOtp(Request $request, Hall $hall): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $sessionToken = session('guest_session_token');
        $guestSession = GuestSession::where('session_token', $sessionToken)
            ->where('status', 'pending')
            ->first();

        if (!$guestSession) {
            return redirect()
                ->route('guest.book', ['hall' => $hall->slug, 'lang' => $locale])
                ->with('error', __('guest.session_expired') !== 'guest.session_expired' 
                    ? __('guest.session_expired') 
                    : 'Session expired. Please start again.');
        }

        // Generate new OTP
        $newOtp = $this->generateOtp();
        $guestSession->update([
            'otp_code' => $newOtp,
            'otp_expires_at' => now()->addMinutes(10),
            'otp_attempts' => 0,
        ]);

        // Send new OTP
        Notification::route('mail', $guestSession->email)
            ->notify(new GuestBookingOtpNotification(
                $newOtp,
                $guestSession->name,
                $hall
            ));

        return back()->with('success', __('guest.otp_resent') !== 'guest.otp_resent' 
            ? __('guest.otp_resent') 
            : 'New verification code sent!');
    }

    /*
    |--------------------------------------------------------------------------
    | STEP 2: Booking Form
    |--------------------------------------------------------------------------
    */

    /**
     * Show booking form (Step 2: Select date, time, services).
     *
     * @param Hall $hall
     * @return View|RedirectResponse
     */
    public function showBookingForm(Hall $hall): View|RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $sessionToken = session('guest_session_token');
        $guestSession = GuestSession::where('session_token', $sessionToken)
            ->where('is_verified', true)
            ->whereIn('status', ['verified', 'booking'])
            ->first();

        if (!$guestSession) {
            return redirect()
                ->route('guest.book', ['hall' => $hall->slug, 'lang' => $locale])
                ->with('error', __('guest.session_invalid') !== 'guest.session_invalid' 
                    ? __('guest.session_invalid') 
                    : 'Session invalid. Please start again.');
        }

        // Load hall with relationships
        $hall->load(['city.region', 'activeExtraServices', 'amenities']);

        return view('customer.guest.booking-form', [
            'hall' => $hall,
            'guestSession' => $guestSession,
        ]);
    }

    /**
     * Store guest booking.
     *
     * @param Request $request
     * @param Hall $hall
     * @return RedirectResponse
     */
    public function store(Request $request, Hall $hall): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Get and validate guest session
        $sessionToken = session('guest_session_token');
        $guestSession = GuestSession::where('session_token', $sessionToken)
            ->where('is_verified', true)
            ->whereIn('status', ['verified', 'booking'])
            ->first();

        if (!$guestSession) {
            return redirect()
                ->route('guest.book', ['hall' => $hall->slug, 'lang' => $locale])
                ->with('error', __('guest.session_invalid') !== 'guest.session_invalid' 
                    ? __('guest.session_invalid') 
                    : 'Session invalid. Please start again.');
        }

        // Validate booking data
        $validator = Validator::make($request->all(), [
            'booking_date' => ['required', 'date', 'after_or_equal:today'],
            'time_slot' => ['required', 'in:morning,afternoon,evening,full_day'],
            'number_of_guests' => [
                'required',
                'integer',
                'min:' . ($hall->capacity_min ?? 1),
                'max:' . ($hall->capacity_max ?? 1000),
            ],
            'customer_notes' => ['nullable', 'string', 'max:1000'],
            'event_type' => ['nullable', 'string', 'max:100'],
            'services' => ['nullable', 'array'],
            'services.*' => ['exists:extra_services,id'],
            'agree_terms' => ['required', 'accepted'],
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator)->withInput();
        }

        // Check availability
        $isAvailable = $this->isSlotAvailable(
            $hall,
            $request->input('booking_date'),
            $request->input('time_slot')
        );

        if (!$isAvailable) {
            return back()
                ->with('error', __('halls.slot_not_available') !== 'halls.slot_not_available' 
                    ? __('halls.slot_not_available') 
                    : 'This slot is not available. Please choose another date or time.')
                ->withInput();
        }

        try {
            DB::beginTransaction();

            // Calculate pricing
            $selectedServices = $request->input('services', []);
            $pricing = $this->calculateBookingTotal($hall, $request->input('time_slot'), $selectedServices);

            // Generate booking number
            $bookingNumber = $this->generateBookingNumber();

            // Generate guest token (64 character hex string)
            $guestToken = bin2hex(random_bytes(32));

            // Create booking
            $booking = Booking::create([
                'booking_number' => $bookingNumber,
                'hall_id' => $hall->id,
                'user_id' => null, // Guest booking - no user
                'is_guest_booking' => true,
                'guest_token' => $guestToken,
                'guest_token_expires_at' => now()->addYear(),
                'booking_date' => $request->input('booking_date'),
                'time_slot' => $request->input('time_slot'),
                'number_of_guests' => (int) $request->input('number_of_guests'),
                'customer_name' => $guestSession->name,
                'customer_email' => $guestSession->email,
                'customer_phone' => $guestSession->phone,
                'customer_notes' => $request->input('customer_notes'),
                'event_type' => $request->input('event_type'),
                'base_price' => $pricing['base_price'],
                'services_price' => $pricing['services_total'],
                'total_amount' => $pricing['total'],
                'status' => 'pending',
                'payment_status' => 'unpaid',
            ]);

            // Attach selected extra services
            if (!empty($selectedServices)) {
                $servicesWithPrices = [];
                foreach ($selectedServices as $serviceId) {
                    $service = ExtraService::find($serviceId);
                    if ($service) {
                        $servicesWithPrices[$serviceId] = ['price' => $service->price];
                    }
                }
                $booking->extraServices()->attach($servicesWithPrices);
            }

            // Update guest session
            $guestSession->update([
                'status' => 'payment',
                'booking_data' => json_encode([
                    'booking_id' => $booking->id,
                    'booking_number' => $booking->booking_number,
                ]),
            ]);

            DB::commit();

            Log::info('Guest booking created', [
                'booking_id' => $booking->id,
                'booking_number' => $booking->booking_number,
                'total_amount' => $booking->total_amount,
                'session_id' => $guestSession->id,
            ]);

            // Redirect to payment
            return redirect()
                ->route('guest.booking.payment', [
                    'guest_token' => $guestToken,
                    'lang' => $locale,
                ])
                ->with('success', __('halls.booking_created_proceed_payment') !== 'halls.booking_created_proceed_payment'
                    ? __('halls.booking_created_proceed_payment')
                    : 'Booking created! Please proceed to payment.');

        } catch (Exception $e) {
            DB::rollBack();

            Log::error('Guest booking creation failed', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
                'session_id' => $guestSession->id,
                'hall_id' => $hall->id,
            ]);

            return back()
                ->with('error', __('halls.booking_failed') !== 'halls.booking_failed'
                    ? __('halls.booking_failed')
                    : 'Failed to create booking. Please try again.')
                ->withInput();
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STEP 3: Payment
    |--------------------------------------------------------------------------
    */

    /**
     * Show booking details for guest (using token).
     *
     * @param string $guestToken
     * @return View|RedirectResponse
     */
    public function show(string $guestToken): View|RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $booking = $this->findBookingByToken($guestToken);

        if (!$booking) {
            return redirect()
                ->route('customer.halls.index')
                ->with('error', __('guest.booking_not_found') !== 'guest.booking_not_found' 
                    ? __('guest.booking_not_found') 
                    : 'Booking not found.');
        }

        $booking->load(['hall.city.region', 'extraServices']);

        return view('customer.guest.booking-details', compact('booking'));
    }

    /**
     * Show payment page for guest booking.
     *
     * @param string $guestToken
     * @return View|RedirectResponse
     */
    public function payment(string $guestToken): View|RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $booking = $this->findBookingByToken($guestToken);

        if (!$booking) {
            return redirect()
                ->route('customer.halls.index')
                ->with('error', __('guest.booking_not_found') !== 'guest.booking_not_found' 
                    ? __('guest.booking_not_found') 
                    : 'Booking not found.');
        }

        // Check if already paid
        if ($booking->payment_status === 'paid') {
            return redirect()
                ->route('guest.booking.success', ['guest_token' => $guestToken, 'lang' => $locale]);
        }

        $booking->load(['hall.city.region', 'extraServices']);

        return view('customer.guest.payment', compact('booking'));
    }

    /**
     * Process payment for guest booking.
     *
     * @param Request $request
     * @param string $guestToken
     * @return RedirectResponse
     */
    public function processPayment(Request $request, string $guestToken): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $booking = $this->findBookingByToken($guestToken);

        if (!$booking) {
            return redirect()
                ->route('customer.halls.index')
                ->with('error', __('guest.booking_not_found') !== 'guest.booking_not_found' 
                    ? __('guest.booking_not_found') 
                    : 'Booking not found.');
        }

        try {
            $hall = $booking->hall;
            $paymentType = $request->input('payment_type', 'full');
            $paymentAmount = (float) $booking->total_amount;

            // Calculate advance payment if selected
            if ($paymentType === 'advance' && ($hall->allows_advance_payment ?? false)) {
                $advancePercentage = $hall->advance_percentage ?? 30;
                $paymentAmount = round($booking->total_amount * ($advancePercentage / 100), 3);
            }

            // Update booking with payment type
            $booking->update(['payment_type' => $paymentType]);

            // Check if Thawani payment service is available
            if ($this->isThawaniConfigured()) {
                return $this->processThawaniPayment($booking, $paymentAmount, $guestToken);
            }

            // Fallback: Direct confirmation (for testing or manual payment)
            Log::warning('Payment gateway not configured, using direct confirmation', [
                'booking_id' => $booking->id,
            ]);

            return redirect()
                ->route('guest.payment.success', ['guest_token' => $guestToken, 'lang' => $locale])
                ->with('info', 'Payment gateway not configured. Booking will be processed manually.');

        } catch (Exception $e) {
            Log::error('Guest payment processing failed', [
                'error' => $e->getMessage(),
                'booking_id' => $booking->id,
            ]);

            return back()->with('error', __('halls.payment_processing_failed') !== 'halls.payment_processing_failed'
                ? __('halls.payment_processing_failed')
                : 'Payment processing failed. Please try again.');
        }
    }

    /**
     * Handle successful payment callback.
     *
     * @param Request $request
     * @param string $guestToken
     * @return RedirectResponse
     */
    public function paymentSuccess(Request $request, string $guestToken): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $booking = $this->findBookingByToken($guestToken);

        if (!$booking) {
            return redirect()
                ->route('customer.halls.index')
                ->with('error', __('guest.booking_not_found') !== 'guest.booking_not_found' 
                    ? __('guest.booking_not_found') 
                    : 'Booking not found.');
        }

        try {
            // Verify payment if session_id provided (Thawani callback)
            $sessionId = $request->query('session_id');
            if ($sessionId && $this->isThawaniConfigured()) {
                $this->verifyThawaniPayment($booking, $sessionId);
            } else {
                // Direct confirmation (fallback)
                $booking->update([
                    'status' => 'confirmed',
                    'payment_status' => 'paid',
                    'paid_at' => now(),
                ]);
            }

            // Update guest session
            $sessionToken = session('guest_session_token');
            if ($sessionToken) {
                GuestSession::where('session_token', $sessionToken)
                    ->update(['status' => 'completed']);
            }

            // Send confirmation email
            try {
                Notification::route('mail', $booking->customer_email)
                    ->notify(new GuestBookingConfirmationNotification($booking));
            } catch (Exception $e) {
                Log::error('Failed to send confirmation email', ['error' => $e->getMessage()]);
            }

            // Clear browser session
            session()->forget('guest_session_token');

            Log::info('Guest payment successful', [
                'booking_id' => $booking->id,
                'booking_number' => $booking->booking_number,
            ]);

            return redirect()
                ->route('guest.booking.success', ['guest_token' => $guestToken, 'lang' => $locale])
                ->with('success', __('halls.payment_successful') !== 'halls.payment_successful'
                    ? __('halls.payment_successful')
                    : 'Payment successful! Your booking is confirmed.');

        } catch (Exception $e) {
            Log::error('Guest payment verification failed', [
                'error' => $e->getMessage(),
                'booking_id' => $booking->id,
            ]);

            return redirect()
                ->route('guest.booking.show', ['guest_token' => $guestToken, 'lang' => $locale])
                ->with('error', __('halls.payment_verification_failed') !== 'halls.payment_verification_failed'
                    ? __('halls.payment_verification_failed')
                    : 'Payment verification failed. Please contact support.');
        }
    }

    /**
     * Handle cancelled payment.
     *
     * @param string $guestToken
     * @return RedirectResponse
     */
    public function paymentCancel(string $guestToken): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        Log::info('Guest payment cancelled', ['guest_token' => substr($guestToken, 0, 8) . '...']);

        return redirect()
            ->route('guest.booking.payment', ['guest_token' => $guestToken, 'lang' => $locale])
            ->with('warning', __('halls.payment_cancelled') !== 'halls.payment_cancelled'
                ? __('halls.payment_cancelled')
                : 'Payment was cancelled. You can try again.');
    }

    /**
     * Show booking success page.
     *
     * @param string $guestToken
     * @return View|RedirectResponse
     */
    public function success(string $guestToken): View|RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $booking = $this->findBookingByToken($guestToken);

        if (!$booking) {
            return redirect()
                ->route('customer.halls.index')
                ->with('error', __('guest.booking_not_found') !== 'guest.booking_not_found' 
                    ? __('guest.booking_not_found') 
                    : 'Booking not found.');
        }

        $booking->load(['hall.city.region', 'extraServices']);

        return view('customer.guest.booking-success', compact('booking'));
    }

    /*
    |--------------------------------------------------------------------------
    | Account Creation
    |--------------------------------------------------------------------------
    */

    /**
     * Create account for guest after booking.
     *
     * @param Request $request
     * @param string $guestToken
     * @return RedirectResponse
     */
    public function createAccount(Request $request, string $guestToken): RedirectResponse
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $booking = $this->findBookingByToken($guestToken);

        if (!$booking) {
            return redirect()
                ->route('customer.halls.index')
                ->with('error', __('guest.booking_not_found') !== 'guest.booking_not_found' 
                    ? __('guest.booking_not_found') 
                    : 'Booking not found.');
        }

        // Validate password
        $validator = Validator::make($request->all(), [
            'password' => ['required', 'confirmed', Password::min(8)],
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator);
        }

        try {
            DB::beginTransaction();

            // Check if user already exists
            if (User::where('email', $booking->customer_email)->exists()) {
                return back()->with('error', __('guest.email_already_registered') !== 'guest.email_already_registered' 
                    ? __('guest.email_already_registered') 
                    : 'This email is already registered. Please login instead.');
            }

            // Create user
            $user = User::create([
                'name' => $booking->customer_name,
                'email' => $booking->customer_email,
                'phone' => $booking->customer_phone,
                'password' => Hash::make($request->input('password')),
                'email_verified_at' => now(), // Already verified via OTP
            ]);

            // Assign customer role if using Spatie permissions
            if (method_exists($user, 'assignRole')) {
                try {
                    $user->assignRole('customer');
                } catch (Exception $e) {
                    // Role might not exist, continue anyway
                    Log::warning('Could not assign customer role', ['error' => $e->getMessage()]);
                }
            }

            // Link all guest bookings with this email to the new user
            Booking::where('customer_email', $booking->customer_email)
                ->where('is_guest_booking', true)
                ->whereNull('user_id')
                ->update([
                    'user_id' => $user->id,
                    'account_created_at' => now(),
                ]);

            DB::commit();

            // Log the user in
            auth()->login($user);

            Log::info('Guest created account after booking', [
                'user_id' => $user->id,
                'booking_id' => $booking->id,
            ]);

            // Try to redirect to customer bookings, fallback to home
            try {
                return redirect()
                    ->route('customer.bookings.index')
                    ->with('success', __('guest.account_created') !== 'guest.account_created'
                        ? __('guest.account_created')
                        : 'Account created successfully! All your bookings have been linked.');
            } catch (Exception $e) {
                return redirect('/')
                    ->with('success', __('guest.account_created') !== 'guest.account_created'
                        ? __('guest.account_created')
                        : 'Account created successfully!');
            }

        } catch (Exception $e) {
            DB::rollBack();

            Log::error('Failed to create account for guest', [
                'error' => $e->getMessage(),
                'booking_id' => $booking->id,
            ]);

            return back()->with('error', __('guest.account_creation_failed') !== 'guest.account_creation_failed'
                ? __('guest.account_creation_failed')
                : 'Failed to create account. Please try again.');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX Endpoints
    |--------------------------------------------------------------------------
    */

    /**
     * Check hall availability (AJAX endpoint).
     *
     * @param Request $request
     * @return JsonResponse
     */
    public function checkAvailability(Request $request): JsonResponse
    {
        try {
            $validator = Validator::make($request->all(), [
                'hall_id' => ['required', 'exists:halls,id'],
                'date' => ['required', 'date', 'after_or_equal:today'],
                'time_slot' => ['required', 'in:morning,afternoon,evening,full_day'],
            ]);

            if ($validator->fails()) {
                return response()->json([
                    'available' => false,
                    'message' => $validator->errors()->first(),
                    'slots' => null,
                ], 422);
            }

            $hall = Hall::find($request->input('hall_id'));
            $date = $request->input('date');
            $timeSlot = $request->input('time_slot');

            $isAvailable = $this->isSlotAvailable($hall, $date, $timeSlot);
            $allSlots = $this->getAvailableSlots($hall, $date);
            $bookedSlots = $this->getBookedSlots($hall, $date);

            return response()->json([
                'available' => $isAvailable,
                'message' => $isAvailable
                    ? (__('halls.slot_available') !== 'halls.slot_available' ? __('halls.slot_available') : 'This slot is available!')
                    : (__('halls.slot_not_available') !== 'halls.slot_not_available' ? __('halls.slot_not_available') : 'This slot is not available.'),
                'slots' => $allSlots,
                'booked_slots' => $bookedSlots,
            ]);

        } catch (Exception $e) {
            Log::error('Availability check failed', [
                'error' => $e->getMessage(),
                'request' => $request->all(),
            ]);

            return response()->json([
                'available' => false,
                'message' => 'Error checking availability. Please try again.',
                'slots' => null,
            ], 500);
        }
    }

    /**
     * Download booking PDF.
     *
     * @param string $guestToken
     * @return mixed
     */
    public function downloadPdf(string $guestToken)
    {
        $booking = $this->findBookingByToken($guestToken);

        if (!$booking) {
            return redirect()
                ->route('customer.halls.index')
                ->with('error', __('guest.booking_not_found') !== 'guest.booking_not_found' 
                    ? __('guest.booking_not_found') 
                    : 'Booking not found.');
        }

        // Check if BookingPdfService exists
        if (class_exists(\App\Services\BookingPdfService::class)) {
            $pdfService = app(\App\Services\BookingPdfService::class);
            return $pdfService->download($booking);
        }

        // Fallback: return booking details as JSON
        $booking->load(['hall', 'extraServices']);
        
        return response()->json([
            'booking_number' => $booking->booking_number,
            'hall' => $booking->hall->name ?? 'N/A',
            'date' => $booking->booking_date->format('Y-m-d'),
            'time_slot' => $booking->time_slot,
            'total' => number_format((float)$booking->total_amount, 3) . ' OMR',
            'status' => $booking->status,
        ]);
    }

    /*
    |--------------------------------------------------------------------------
    | Helper Methods - Availability
    |--------------------------------------------------------------------------
    */

    /**
     * Check if a time slot is available.
     *
     * @param Hall $hall
     * @param string $date
     * @param string $timeSlot
     * @return bool
     */
    protected function isSlotAvailable(Hall $hall, string $date, string $timeSlot): bool
    {
        $baseQuery = Booking::where('hall_id', $hall->id)
            ->where('booking_date', $date)
            ->whereIn('status', ['confirmed', 'pending']);

        // Full day: blocked if ANY slot is booked
        if ($timeSlot === 'full_day') {
            return !$baseQuery->exists();
        }

        // Individual slot: blocked if same slot OR full_day is booked
        return !(clone $baseQuery)->where(function ($query) use ($timeSlot) {
            $query->where('time_slot', $timeSlot)
                  ->orWhere('time_slot', 'full_day');
        })->exists();
    }

    /**
     * Get availability for all slots on a date.
     *
     * @param Hall $hall
     * @param string $date
     * @return array
     */
    protected function getAvailableSlots(Hall $hall, string $date): array
    {
        $slots = ['morning', 'afternoon', 'evening', 'full_day'];
        $availability = [];

        foreach ($slots as $slot) {
            $availability[$slot] = $this->isSlotAvailable($hall, $date, $slot);
        }

        return $availability;
    }

    /**
     * Get booked slots for a date.
     *
     * @param Hall $hall
     * @param string $date
     * @return array
     */
    protected function getBookedSlots(Hall $hall, string $date): array
    {
        return Booking::where('hall_id', $hall->id)
            ->where('booking_date', $date)
            ->whereIn('status', ['confirmed', 'pending'])
            ->pluck('time_slot')
            ->toArray();
    }

    /*
    |--------------------------------------------------------------------------
    | Helper Methods - Pricing
    |--------------------------------------------------------------------------
    */

    /**
     * Calculate booking total including hall price and services.
     *
     * @param Hall $hall
     * @param string $timeSlot
     * @param array $serviceIds
     * @return array
     */
    protected function calculateBookingTotal(Hall $hall, string $timeSlot, array $serviceIds = []): array
    {
        // Get base price based on time slot
        $basePrice = $this->getSlotPrice($hall, $timeSlot);

        // Calculate services total
        $servicesTotal = 0.0;
        $servicesDetails = [];

        if (!empty($serviceIds)) {
            $services = ExtraService::whereIn('id', $serviceIds)->get();
            foreach ($services as $service) {
                $servicesTotal += (float) $service->price;
                $servicesDetails[] = [
                    'id' => $service->id,
                    'name' => $service->name,
                    'price' => $service->price,
                ];
            }
        }

        $total = $basePrice + $servicesTotal;

        return [
            'base_price' => round($basePrice, 3),
            'services_total' => round($servicesTotal, 3),
            'services' => $servicesDetails,
            'total' => round($total, 3),
        ];
    }

    /**
     * Get price for a specific time slot.
     *
     * @param Hall $hall
     * @param string $timeSlot
     * @return float
     */
    protected function getSlotPrice(Hall $hall, string $timeSlot): float
    {
        // Check if hall has slot-specific pricing columns
        $priceField = "price_{$timeSlot}";
        if (isset($hall->{$priceField}) && $hall->{$priceField} > 0) {
            return (float) $hall->{$priceField};
        }

        // Check for pricing JSON/array
        if (isset($hall->prices) && is_array($hall->prices) && isset($hall->prices[$timeSlot])) {
            return (float) $hall->prices[$timeSlot];
        }

        // Default: use price_per_slot or base price
        $basePrice = (float) ($hall->price_per_slot ?? $hall->price ?? 0);

        // Apply multiplier for full day (if not specifically priced)
        if ($timeSlot === 'full_day') {
            $multiplier = $hall->full_day_multiplier ?? 2.5;
            return $basePrice * $multiplier;
        }

        return $basePrice;
    }

    /*
    |--------------------------------------------------------------------------
    | Helper Methods - Utilities
    |--------------------------------------------------------------------------
    */

    /**
     * Generate 6-digit OTP code.
     *
     * @return string
     */
    protected function generateOtp(): string
    {
        return str_pad((string) random_int(0, 999999), 6, '0', STR_PAD_LEFT);
    }

    /**
     * Generate unique booking number.
     *
     * @return string
     */
    protected function generateBookingNumber(): string
    {
        $prefix = 'MJL';
        $date = now()->format('ymd');
        $random = strtoupper(Str::random(4));
        
        return "{$prefix}-{$date}-{$random}";
    }

    /**
     * Find booking by guest token.
     *
     * @param string $guestToken
     * @return Booking|null
     */
    protected function findBookingByToken(string $guestToken): ?Booking
    {
        return Booking::where('guest_token', $guestToken)
            ->where('is_guest_booking', true)
            ->where(function ($query) {
                $query->whereNull('guest_token_expires_at')
                      ->orWhere('guest_token_expires_at', '>', now());
            })
            ->first();
    }

    /**
     * Mask email for display.
     *
     * @param string $email
     * @return string
     */
    protected function maskEmail(string $email): string
    {
        $parts = explode('@', $email);
        if (count($parts) !== 2) {
            return '***@***.***';
        }

        $name = $parts[0];
        $domain = $parts[1];

        $maskedName = strlen($name) > 2
            ? substr($name, 0, 2) . str_repeat('*', min(strlen($name) - 2, 5))
            : $name;

        return "{$maskedName}@{$domain}";
    }

    /*
    |--------------------------------------------------------------------------
    | Helper Methods - Payment (Thawani)
    |--------------------------------------------------------------------------
    */

    /**
     * Check if Thawani payment gateway is configured.
     *
     * @return bool
     */
    protected function isThawaniConfigured(): bool
    {
        return !empty(config('services.thawani.secret_key'))
            && !empty(config('services.thawani.publishable_key'));
    }

    /**
     * Process payment via Thawani gateway.
     *
     * @param Booking $booking
     * @param float $amount
     * @param string $guestToken
     * @return RedirectResponse
     */
    protected function processThawaniPayment(Booking $booking, float $amount, string $guestToken): RedirectResponse
    {
        $locale = app()->getLocale();
        
        // Thawani expects amount in baisas (1 OMR = 1000 baisas)
        $amountInBaisas = (int) round($amount * 1000);

        $payload = [
            'client_reference_id' => $booking->booking_number,
            'mode' => 'payment',
            'products' => [
                [
                    'name' => "Booking #{$booking->booking_number}",
                    'quantity' => 1,
                    'unit_amount' => $amountInBaisas,
                ],
            ],
            'success_url' => route('guest.payment.success', ['guest_token' => $guestToken, 'lang' => $locale]) . '?session_id={session_id}',
            'cancel_url' => route('guest.payment.cancel', ['guest_token' => $guestToken, 'lang' => $locale]),
            'metadata' => [
                'booking_id' => $booking->id,
                'guest_token' => $guestToken,
                'customer_email' => $booking->customer_email,
            ],
        ];

        // Add customer info if available
        if ($booking->customer_email) {
            $payload['customer_id'] = $booking->customer_email;
        }

        try {
            $response = $this->thawaniRequest('POST', '/checkout/session', $payload);

            if (isset($response['data']['session_id'])) {
                $sessionId = $response['data']['session_id'];
                
                // Store session ID in booking for verification
                $booking->update(['payment_session_id' => $sessionId]);

                // Redirect to Thawani checkout
                $checkoutUrl = config('services.thawani.checkout_url', 'https://checkout.thawani.om/pay/');
                return redirect()->away($checkoutUrl . $sessionId);
            }

            throw new Exception('Invalid response from payment gateway');

        } catch (Exception $e) {
            Log::error('Thawani payment creation failed', [
                'error' => $e->getMessage(),
                'booking_id' => $booking->id,
            ]);

            return back()->with('error', 'Payment gateway error. Please try again.');
        }
    }

    /**
     * Verify Thawani payment.
     *
     * @param Booking $booking
     * @param string $sessionId
     * @return void
     */
    protected function verifyThawaniPayment(Booking $booking, string $sessionId): void
    {
        try {
            $response = $this->thawaniRequest('GET', "/checkout/session/{$sessionId}");

            if (isset($response['data']['payment_status']) && $response['data']['payment_status'] === 'paid') {
                $booking->update([
                    'status' => 'confirmed',
                    'payment_status' => 'paid',
                    'paid_at' => now(),
                    'payment_reference' => $sessionId,
                ]);
            } else {
                throw new Exception('Payment not completed');
            }

        } catch (Exception $e) {
            Log::error('Thawani verification failed', [
                'error' => $e->getMessage(),
                'session_id' => $sessionId,
            ]);
            throw $e;
        }
    }

    /**
     * Make request to Thawani API.
     *
     * @param string $method
     * @param string $endpoint
     * @param array $data
     * @return array
     */
    protected function thawaniRequest(string $method, string $endpoint, array $data = []): array
    {
        $baseUrl = config('services.thawani.base_url', 'https://checkout.thawani.om/api/v1');
        $secretKey = config('services.thawani.secret_key');

        $ch = curl_init();

        $url = $baseUrl . $endpoint;
        $headers = [
            'Content-Type: application/json',
            'thawani-api-key: ' . $secretKey,
        ];

        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);

        if ($method === 'POST') {
            curl_setopt($ch, CURLOPT_POST, true);
            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
        }

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $error = curl_error($ch);
        curl_close($ch);

        if ($error) {
            throw new Exception("cURL error: {$error}");
        }

        if ($httpCode >= 400) {
            throw new Exception("Thawani API error: HTTP {$httpCode}");
        }

        return json_decode($response, true) ?? [];
    }
}
