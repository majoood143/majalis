<?php

declare(strict_types=1);

namespace App\Http\Controllers\Customer;

use Illuminate\Routing\Controller as BaseController;
use App\Models\Booking;
use App\Models\Hall;
use App\Models\Payment;
use App\Services\BookingService;
use App\Services\PaymentService;
use App\Services\BookingPdfService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\DB;
use Exception;
use Illuminate\Support\Facades\Log;

/**
 * Controller for handling customer booking operations
 *
 * @package App\Http\Controllers\Customer
 */
class BookingController extends BaseController
{
    /**
     * BookingController constructor
     * Apply authentication middleware
     */
    public function __construct()
    {
        // Apply auth middleware to all methods except checkAvailability
        $this->middleware('auth')->except(['checkAvailability']);
    }

    /**
     * Show the booking form for a specific hall
     *
     * @param Hall $hall
     * @return \Illuminate\View\View
     */
    public function create(Hall $hall)
    {
        // Set locale from query parameter or session
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);
        session(['locale' => $locale]);

        // Check if hall is active
        if (!$hall->is_active) {
            abort(404, 'Hall not found or inactive');
        }

        // Load necessary relationships
        $hall->load(['city.region', 'owner', 'activeExtraServices']);

        return view('customer.book', compact('hall'));
    }

    /**
     * Store a new booking
     *
     * @param Request $request
     * @param Hall $hall
     * @return \Illuminate\Http\RedirectResponse
     */
    public function store(Request $request, Hall $hall)
    {
        // Set locale
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Get services from container
        $bookingService = app(BookingService::class);

        // Validation
        $validator = Validator::make($request->all(), [
            'booking_date' => 'required|date|after:today',
            'time_slot' => 'required|in:morning,afternoon,evening,full_day',
            'number_of_guests' => "required|integer|min:{$hall->capacity_min}|max:{$hall->capacity_max}",
            'customer_name' => 'required|string|max:255',
            'customer_email' => 'required|email|max:255',
            'customer_phone' => 'required|string|max:20',
            'customer_notes' => 'nullable|string|max:1000',
            'event_type' => 'nullable|string|in:wedding,corporate,birthday,conference,graduation,other',
            'event_details' => 'nullable|string|max:1000',
            'services' => 'nullable|array',
            'services.*' => 'exists:extra_services,id',
        ]);

        if ($validator->fails()) {
            return back()
                ->withErrors($validator)
                ->withInput()
                ->with('error', __('halls.invalid_request'));
        }

        try {
            // Check availability using the service
            if (!$bookingService->checkAvailability(
                $hall->id,
                $request->booking_date,
                $request->time_slot
            )) {
                return back()
                    ->with('error', __('halls.date_not_available'))
                    ->withInput();
            }

            // Prepare booking data for the service
            $bookingData = [
                'hall_id' => $hall->id,
                'user_id' => Auth::id(),
                'booking_date' => $request->booking_date,
                'time_slot' => $request->time_slot,
                'number_of_guests' => $request->number_of_guests,
                'customer_name' => $request->customer_name,
                'customer_email' => $request->customer_email,
                'customer_phone' => $request->customer_phone,
                'customer_notes' => $request->customer_notes,
                'event_type' => $request->event_type,
                'event_details' => $request->event_details,
                'extra_services' => $request->services ?? [],
            ];

            // Create booking using the service
            $booking = $bookingService->createBooking($bookingData);

            // ✅ NEW: Calculate advance payment if hall requires it
            $booking->calculateAdvancePayment();
            $booking->save();

            // Determine payment amount (advance or full)
            $paymentAmount = $booking->isAdvancePayment()
                ? $booking->advance_amount
                : $booking->total_amount;

            // Redirect based on payment amount
            if ($paymentAmount > 0) {
                return redirect()
                    ->route('customer.booking.payment', ['booking' => $booking->id, 'lang' => $locale])
                    ->with('success', __('halls.booking_success'));
            }

            // No payment needed, go directly to success page
            return redirect()
                ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                ->with('success', __('halls.booking_success'));

            // // Redirect based on payment amount
            // if ($booking->total_amount > 0) {
            //     return redirect()
            //         ->route('customer.booking.payment', ['booking' => $booking->id, 'lang' => $locale])
            //         ->with('success', __('halls.booking_success'));
            // }

            // No payment needed, go directly to success page
            return redirect()
                ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                ->with('success', __('halls.booking_success'));
        } catch (Exception $e) {
            Log::error('Booking creation failed: ' . $e->getMessage(), [
                'hall_id' => $hall->id,
                'user_id' => Auth::id(),
                'exception' => $e
            ]);

            return back()
                ->with('error', __('halls.booking_failed') . ' ' . $e->getMessage())
                ->withInput();
        }
    }

    /**
     * Show booking success page
     *
     * @param string $bookingNumber
     * @return \Illuminate\View\View
     */
    public function success(string $bookingNumber)
    {
        // Set locale
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Find booking by booking_number (not booking_reference)
        $booking = Booking::with(['hall.city.region', 'extraServices', 'user'])
            ->where('booking_number', $bookingNumber)
            ->where('user_id', Auth::id())
            ->firstOrFail();

        return view('customer.booking-success', compact('booking'));
    }

    /**
     * Show user's bookings list
     *
     * @return \Illuminate\View\View
     */
    public function index()
    {
        // Set locale
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        $bookings = Booking::with(['hall.city'])
            ->where('user_id', Auth::id())
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        return view('customer.bookings.index', compact('bookings'));
    }

    /**
     * Show specific booking details
     *
     * @param Booking $booking
     * @return \Illuminate\View\View
     */
    public function show(Booking $booking)
    {
        // Set locale
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Ensure user owns this booking
        if ($booking->user_id !== Auth::id()) {
            abort(403, 'Unauthorized access to booking');
        }

        $booking->load(['hall.city.region', 'extraServices', 'user']);

        return view('customer.bookings.show', compact('booking'));
    }

    /**
     * Show payment page
     *
     * @param Booking $booking
     * @return \Illuminate\View\View|\Illuminate\Http\RedirectResponse
     */
    public function payment(Booking $booking)
    {
        // Set locale
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Ensure user owns this booking
        if ($booking->user_id !== Auth::id()) {
            abort(403, 'Unauthorized access to booking');
        }

        // Check if already paid
        if ($booking->payment_status === 'paid') {
            return redirect()
                ->route('customer.booking.success', ['reference' => $booking->booking_reference, 'lang' => $locale])
                ->with('info', __('halls.already_paid'));
        }

        $booking->load(['hall.city', 'extraServices']);

        return view('customer.payment', compact('booking'));
    }

    /**
     * Process payment
     *
     * @param Request $request
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    // public function processPayment(Request $request, Booking $booking)
    // {
    //     // Set locale
    //     $locale = request()->get('lang', session('locale', 'ar'));
    //     app()->setLocale($locale);

    //     // Validate payment method
    //     $request->validate([
    //         'payment_method' => 'required|in:online,bank_transfer,cash',
    //     ]);

    //     $paymentService = app(PaymentService::class);

    //     // Ensure user owns this booking
    //     if ($booking->user_id !== Auth::id()) {
    //         abort(403, 'Unauthorized access to booking');
    //     }

    //     // Check if already paid
    //     if ($booking->payment_status === 'paid') {
    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('info', __('halls.already_paid'));
    //     }

    //     try {
    //         $paymentMethod = $request->input('payment_method');

    //         // Initiate payment
    //         $paymentData = $paymentService->initiatePayment($booking, $paymentMethod);

    //         if (!$paymentData['success']) {
    //             return back()->with('error', __('halls.payment_failed'));
    //         }

    //         // For online payment, redirect to gateway
    //         if ($paymentMethod === 'online' && isset($paymentData['redirect_url'])) {
    //             return redirect($paymentData['redirect_url']);
    //         }

    //         // For cash or bank transfer, go directly to success page with pending status
    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('success', __('halls.booking_success_pending_payment'));
    //     } catch (Exception $e) {
    //         Log::error('Payment processing failed: ' . $e->getMessage(), [
    //             'booking_id' => $booking->id,
    //             'exception' => $e
    //         ]);

    //         return back()->with('error', __('halls.payment_failed') . ' ' . $e->getMessage());
    //     }
    // }

    /**
     * Process payment
     *
     * @param Request $request
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    // public function processPayment(Request $request, Booking $booking)
    // {
    //     // Set locale
    //     $locale = request()->get('lang', session('locale', 'ar'));
    //     app()->setLocale($locale);

    //     // Validate payment method
    //     $request->validate([
    //         'payment_method' => 'required|in:online,bank_transfer,cash',
    //     ]);

    //     $paymentService = app(PaymentService::class);

    //     // Ensure user owns this booking
    //     if ($booking->user_id !== Auth::id()) {
    //         abort(403, 'Unauthorized access to booking');
    //     }

    //     // Check if already paid
    //     if ($booking->payment_status === 'paid') {
    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('info', __('halls.already_paid'));
    //     }

    //     try {
    //         $paymentMethod = $request->input('payment_method');

    //         Log::info('Processing payment', [
    //             'booking_id' => $booking->id,
    //             'booking_number' => $booking->booking_number,
    //             'payment_method' => $paymentMethod,
    //             'amount' => $booking->total_amount,
    //         ]);

    //         // Initiate payment
    //         $paymentData = $paymentService->initiatePayment($booking, $paymentMethod);

    //         Log::info('Payment initiated', [
    //             'booking_id' => $booking->id,
    //             'payment_data' => $paymentData,
    //         ]);

    //         if (!$paymentData['success']) {
    //             Log::error('Payment initiation failed', [
    //                 'booking_id' => $booking->id,
    //                 'payment_data' => $paymentData,
    //             ]);
    //             return back()->with('error', __('halls.payment_failed'));
    //         }

    //         // For online payment, redirect to gateway
    //         if ($paymentMethod === 'online' && isset($paymentData['redirect_url'])) {
    //             Log::info('Redirecting to payment gateway', [
    //                 'booking_id' => $booking->id,
    //                 'redirect_url' => $paymentData['redirect_url'],
    //             ]);

    //             // Debug: Show the URL before redirect
    //             if (config('app.debug')) {
    //                 dd([
    //                     'message' => 'About to redirect to payment gateway',
    //                     'booking' => $booking->booking_number,
    //                     'payment_method' => $paymentMethod,
    //                     'redirect_url' => $paymentData['redirect_url'],
    //                     'payment_data' => $paymentData,
    //                 ]);
    //             }

    //             return redirect($paymentData['redirect_url']);
    //         }

    //         // For cash or bank transfer, go directly to success page with pending status
    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('success', __('halls.booking_success_pending_payment'));
    //     } catch (Exception $e) {
    //         Log::error('Payment processing exception', [
    //             'booking_id' => $booking->id,
    //             'error' => $e->getMessage(),
    //             'trace' => $e->getTraceAsString(),
    //         ]);

    //         return back()->with('error', __('halls.payment_failed') . ' Error: ' . $e->getMessage());
    //     }
    // }

    /**
     * Process payment
     *
     * @param Request $request
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    // public function processPayment(Request $request, Booking $booking)
    // {
    //     // Set locale
    //     $locale = request()->get('lang', session('locale', 'ar'));
    //     app()->setLocale($locale);

    //     // Validate payment method
    //     $request->validate([
    //         'payment_method' => 'required|in:online,bank_transfer,cash',
    //     ]);

    //     $paymentService = app(PaymentService::class);

    //     // Ensure user owns this booking
    //     if ($booking->user_id !== Auth::id()) {
    //         abort(403, 'Unauthorized access to booking');
    //     }

    //     // Check if already paid
    //     if ($booking->payment_status === 'paid') {
    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('info', __('halls.already_paid'));
    //     }

    //     try {
    //         $paymentMethod = $request->input('payment_method');

    //         Log::info('Processing payment', [
    //             'booking_id' => $booking->id,
    //             'booking_number' => $booking->booking_number,
    //             'payment_method' => $paymentMethod,
    //             'amount' => $booking->total_amount,
    //         ]);

    //         // Initiate payment
    //         $paymentData = $paymentService->initiatePayment($booking, $paymentMethod);

    //         Log::info('Payment initiated', [
    //             'booking_id' => $booking->id,
    //             'payment_data' => $paymentData,
    //         ]);

    //         if (!$paymentData['success']) {
    //             Log::error('Payment initiation failed', [
    //                 'booking_id' => $booking->id,
    //                 'payment_data' => $paymentData,
    //             ]);

    //             // If online payment fails, offer alternative payment methods
    //             if ($paymentMethod === 'online') {
    //                 return back()->with('error', __('halls.payment_gateway_error') . ' ' . __('halls.try_alternative_payment'));
    //             }

    //             return back()->with('error', __('halls.payment_failed'));
    //         }

    //         // For online payment, redirect to gateway
    //         if ($paymentMethod === 'online' && isset($paymentData['redirect_url'])) {
    //             Log::info('Redirecting to payment gateway', [
    //                 'booking_id' => $booking->id,
    //                 'redirect_url' => $paymentData['redirect_url'],
    //             ]);

    //             return redirect($paymentData['redirect_url']);
    //         }

    //         // For cash or bank transfer, go directly to success page with pending status
    //         // Generate PDF even if payment is pending
    //         try {
    //             $pdfService = app(BookingPdfService::class);
    //             $pdfService->generateConfirmation($booking);
    //         } catch (Exception $e) {
    //             Log::warning('PDF generation failed: ' . $e->getMessage());
    //         }

    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('success', __('halls.booking_success_pending_payment'));
    //     } catch (Exception $e) {
    //         Log::error('Payment processing exception', [
    //             'booking_id' => $booking->id,
    //             'error' => $e->getMessage(),
    //             'trace' => $e->getTraceAsString(),
    //         ]);

    //         // For online payment failures, redirect to success with pending payment
    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('warning', __('halls.payment_gateway_unavailable') . ' ' . __('halls.booking_confirmed_payment_pending'));
    //     }
    // }

    /**
     * Handle successful payment callback
     */
    // public function paymentSuccess(Booking $booking)
    // {
    //     $locale = request()->get('lang', session('locale', 'ar'));
    //     app()->setLocale($locale);

    //     // Ensure user owns this booking
    //     if ($booking->user_id !== Auth::id()) {
    //         abort(403);
    //     }

    //     try {
    //         $paymentService = app(PaymentService::class);
    //         $pdfService = app(BookingPdfService::class);

    //         // Get the latest payment for this booking
    //         $payment = $booking->latestPayment;

    //         if ($payment && $payment->isPending() && $payment->transaction_id) {
    //             // Verify payment with Thawani
    //             $verification = $paymentService->verifyPayment($payment);

    //             if ($verification['success'] && $verification['is_paid']) {
    //                 // Process successful payment
    //                 $paymentService->processSuccessfulPayment($payment, $verification['data']);

    //                 // Generate PDF
    //                 $pdfService->generateConfirmation($booking);

    //                 return redirect()
    //                     ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //                     ->with('success', __('halls.payment_successful'));
    //             }
    //         }

    //         // If payment is already processed or verification failed
    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('warning', __('halls.payment_verification_pending'));
    //     } catch (Exception $e) {
    //         Log::error('Payment success handling failed: ' . $e->getMessage(), [
    //             'booking_id' => $booking->id,
    //         ]);

    //         return redirect()
    //             ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
    //             ->with('warning', __('halls.payment_verification_pending'));
    //     }
    // }

    /**
     * Handle cancelled payment
     */
    // public function paymentCancel(Booking $booking)
    // {
    //     $locale = request()->get('lang', session('locale', 'ar'));
    //     app()->setLocale($locale);

    //     // Mark latest payment as cancelled
    //     $payment = $booking->latestPayment;
    //     if ($payment && $payment->isPending()) {
    //         $payment->update([
    //             'status' => Payment::STATUS_CANCELLED,
    //         ]);
    //     }

    //     return redirect()
    //         ->route('customer.booking.payment', ['booking' => $booking->id, 'lang' => $locale])
    //         ->with('error', __('halls.payment_cancelled'));
    // }

    /**
     * Process payment for booking
     *
     * Handles payment method selection and initiates payment flow
     *
     * @param Request $request
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    public function processPayment(Request $request, Booking $booking)
    {
        // Set locale
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Validate payment method
        $request->validate([
            'payment_method' => 'required|in:online,bank_transfer,cash',
        ]);

        $paymentService = app(PaymentService::class);

        // Ensure user owns this booking (skip for guest bookings)
        if ($booking->user_id && $booking->user_id !== Auth::id()) {
            abort(403, 'Unauthorized access to booking');
        }

        // Check if already paid
        if ($booking->payment_status === 'paid') {
            return redirect()
                ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                ->with('info', __('halls.already_paid'));
        }

        try {
            $paymentMethod = $request->input('payment_method');

            Log::info('Processing payment', [
                'booking_id' => $booking->id,
                'booking_number' => $booking->booking_number,
                'payment_method' => $paymentMethod,
                'amount' => $booking->total_amount,
            ]);

            // Initiate payment through PaymentService
            $paymentData = $paymentService->initiatePayment($booking, $paymentMethod);

            if (!$paymentData['success']) {
                Log::error('Payment initiation failed', [
                    'booking_id' => $booking->id,
                    'error' => $paymentData['message'] ?? 'Unknown error',
                ]);

                return back()->with('error', $paymentData['message'] ?? __('halls.payment_failed'));
            }

            // For online payment, redirect to Thawani gateway
            if ($paymentMethod === 'online' && isset($paymentData['redirect_url'])) {
                Log::info('Redirecting to payment gateway', [
                    'booking_id' => $booking->id,
                    'redirect_url' => $paymentData['redirect_url'],
                    'session_id' => $paymentData['session_id'] ?? null,
                ]);

                return redirect($paymentData['redirect_url']);
            }

            // For cash or bank transfer, go directly to success page with pending status
            return redirect()
                ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                ->with('success', __('halls.booking_success_pending_payment'));
        } catch (Exception $e) {
            Log::error('Payment processing exception', [
                'booking_id' => $booking->id,
                'payment_method' => $paymentMethod ?? 'unknown',
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            return back()->with('error', __('halls.payment_failed') . ': ' . $e->getMessage());
        }
    }

    /**
     * Handle successful payment callback from Thawani
     *
     * ✅ FIX: 3 bugs resolved:
     * 1. $booking->latestPayment — relationship didn't exist, replaced with
     *    direct query: Payment::where('booking_id', ...)->latest()->first()
     * 2. $paymentService->verifyPaymentBySessionId() — method didn't exist,
     *    replaced with handlePaymentSuccess() which verifies AND updates status
     * 3. $paymentService->processSuccessfulPayment() — method didn't exist,
     *    handlePaymentSuccess() already handles the full flow
     *
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    public function paymentSuccess(Booking $booking)
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Get session_id from query parameter (Thawani sends this on redirect)
        $sessionIdFromCallback = request()->query('session_id');

        Log::info('Payment success callback received', [
            'booking_id' => $booking->id,
            'session_id_from_callback' => $sessionIdFromCallback,
            'full_url' => request()->fullUrl(),
            'all_params' => request()->all(),
        ]);

        // Ensure user owns this booking (skip for guest bookings)
        if ($booking->user_id && $booking->user_id !== Auth::id()) {
            abort(403);
        }

        try {
            $paymentService = app(PaymentService::class);

            /**
             * ✅ FIX #1: Get the latest payment using direct query
             * Old code: $booking->latestPayment (relationship not defined in Booking model)
             * New code: Query Payment model directly, ordered by latest first
             */
            $payment = Payment::where('booking_id', $booking->id)
                ->latest()
                ->first();

            if (!$payment) {
                Log::error('No payment found for booking', [
                    'booking_id' => $booking->id,
                ]);

                return redirect()
                    ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                    ->with('error', __('halls.payment_not_found'));
            }

            Log::info('Payment found for verification', [
                'payment_id' => $payment->id,
                'payment_status' => $payment->status,
                'payment_reference' => $payment->payment_reference,
                'stored_transaction_id' => $payment->transaction_id,
            ]);

            // If payment is already paid, just redirect to success
            if ($payment->isPaid()) {
                Log::info('Payment already marked as paid', [
                    'payment_id' => $payment->id,
                ]);

                return redirect()
                    ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                    ->with('success', __('halls.payment_successful'));
            }

            // Get session_id: prefer callback param, fallback to stored transaction_id
            $sessionId = $sessionIdFromCallback ?? $payment->transaction_id;

            Log::info('Using session ID for verification', [
                'session_id' => $sessionId,
                'source' => $sessionIdFromCallback ? 'callback' : 'stored',
            ]);

            // If we have a session_id and payment is not yet paid, verify with Thawani
            if ($sessionId && ($payment->isPending() || $payment->isProcessing())) {
                Log::info('Verifying payment with Thawani', [
                    'payment_id' => $payment->id,
                    'session_id' => $sessionId,
                ]);

                try {
                    /**
                     * ✅ FIX #2 & #3: Use handlePaymentSuccess() instead of
                     * non-existent verifyPaymentBySessionId() + processSuccessfulPayment()
                     *
                     * handlePaymentSuccess() already does the complete flow:
                     * - Finds Payment by booking_id + transaction_id
                     * - Calls Thawani API (getSessionStatus) to verify
                     * - If paid → updates payment.status = 'paid', sets paid_at
                     * - If full payment → booking.payment_status = 'paid'
                     * - If advance payment → booking.payment_status = 'partial'
                     * - Sets booking.status = 'confirmed', confirmed_at = now()
                     */
                    $result = $paymentService->handlePaymentSuccess($sessionId, $booking);

                    Log::info('Thawani verification result', [
                        'payment_id' => $payment->id,
                        'result' => $result,
                    ]);

                    if (isset($result['success']) && $result['success'] === true) {
                        Log::info('Payment successfully processed and marked as paid', [
                            'payment_id' => $payment->id,
                            'payment_reference' => $payment->payment_reference,
                            'booking_payment_status' => $result['booking_status'] ?? null,
                            'is_advance' => $result['is_advance'] ?? false,
                        ]);

                        // Generate PDF if service available
                        try {
                            $pdfService = app(\App\Services\BookingPdfService::class);
                            $pdfService->generateConfirmation($booking->fresh());

                            Log::info('Booking confirmation PDF generated', [
                                'booking_id' => $booking->id,
                            ]);
                        } catch (Exception $e) {
                            // PDF generation is non-critical, don't block the flow
                            Log::warning('PDF generation failed (non-critical)', [
                                'booking_id' => $booking->id,
                                'error' => $e->getMessage(),
                            ]);
                        }

                        return redirect()
                            ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                            ->with('success', __('halls.payment_successful'));
                    } else {
                        // Payment not yet completed or verification failed
                        Log::warning('Payment verification incomplete', [
                            'payment_id' => $payment->id,
                            'session_id' => $sessionId,
                            'result_message' => $result['message'] ?? 'unknown',
                        ]);

                        return redirect()
                            ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                            ->with('warning', __('halls.payment_verification_pending'));
                    }
                } catch (Exception $e) {
                    Log::error('Payment verification exception', [
                        'payment_id' => $payment->id,
                        'session_id' => $sessionId,
                        'error' => $e->getMessage(),
                    ]);

                    // Don't fail completely, still redirect to success page
                    return redirect()
                        ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                        ->with('warning', __('halls.payment_verification_pending'));
                }
            }

            // No session_id available or payment already in final state
            if ($payment->isPaid()) {
                return redirect()
                    ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                    ->with('success', __('halls.payment_successful'));
            }

            // Payment verification pending — no session ID available
            Log::warning('Payment verification pending - no session ID available', [
                'payment_id' => $payment->id,
                'payment_status' => $payment->status,
            ]);

            return redirect()
                ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                ->with('warning', __('halls.payment_verification_pending'));
        } catch (Exception $e) {
            Log::error('Payment success handling failed', [
                'booking_id' => $booking->id,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()
                ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                ->with('warning', __('halls.payment_verification_pending'));
        }
    }

    /**
     * Handle cancelled payment
     *
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    public function paymentCancel(Booking $booking)
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        Log::info('Payment cancelled by user', [
            'booking_id' => $booking->id,
            'booking_number' => $booking->booking_number,
            'full_url' => request()->fullUrl(),
        ]);

        // Ensure user owns this booking (skip for guest bookings)
        if ($booking->user_id && $booking->user_id !== Auth::id()) {
            abort(403);
        }

        // ✅ FIX: Get the latest payment using direct query (latestPayment relationship not defined)
        $payment = Payment::where('booking_id', $booking->id)->latest()->first();

        if ($payment && ($payment->isPending() || $payment->isProcessing())) {
            $payment->update([
                'status' => \App\Models\Payment::STATUS_CANCELLED,
                'failure_reason' => 'Payment cancelled by customer',
                'failed_at' => now(),
            ]);

            Log::info('Payment status updated to cancelled', [
                'payment_id' => $payment->id,
                'payment_reference' => $payment->payment_reference,
            ]);
        }

        // Redirect to cancellation page
        return redirect()
            ->route('customer.booking.cancelled', ['booking' => $booking->id, 'lang' => $locale])
            ->with('warning', __('halls.payment_cancelled_message'));
    }

    /**
     * Cancel booking
     *
     * @param Request $request
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    public function cancel(Request $request, Booking $booking)
    {
        // Set locale
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Ensure user owns this booking
        if ($booking->user_id !== Auth::id()) {
            abort(403, 'Unauthorized access to booking');
        }

        // Check if cancellation is allowed
        if (!in_array($booking->status, ['pending', 'confirmed'])) {
            return back()->with('error', __('halls.cannot_cancel'));
        }

        try {
            DB::beginTransaction();

            $booking->update([
                'status' => 'cancelled',
                'cancelled_at' => now(),
                'cancellation_reason' => $request->input('reason', 'Cancelled by customer'),
            ]);

            // Handle refund logic if needed
            // If paid, initiate refund through PaymentService
            if ($booking->payment_status === 'paid') {
                // $paymentService = app(PaymentService::class);
                // $paymentService->processRefund($booking);
            }

            DB::commit();

            return redirect()
                ->route('customer.bookings.index', ['lang' => $locale])
                ->with('success', __('halls.booking_cancelled'));
        } catch (Exception $e) {
            DB::rollBack();

            Log::error('Booking cancellation failed: ' . $e->getMessage(), [
                'booking_id' => $booking->id,
                'exception' => $e
            ]);

            return back()->with('error', __('halls.cancellation_failed') . ' ' . $e->getMessage());
        }
    }

    /**
     * Check availability via AJAX
     *
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function checkAvailability(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'hall_id' => 'required|exists:halls,id',
            'booking_date' => 'required|date|after:today',
            'time_slot' => 'required|in:morning,afternoon,evening,full_day',
        ]);

        if ($validator->fails()) {
            return response()->json([
                'available' => false,
                'message' => __('halls.invalid_request')
            ], 422);
        }

        try {
            $bookingService = app(BookingService::class);

            $available = $bookingService->checkAvailability(
                $request->hall_id,
                $request->booking_date,
                $request->time_slot
            );

            return response()->json([
                'available' => $available,
                'message' => $available
                    ? __('halls.date_available')
                    : __('halls.date_not_available')
            ]);
        } catch (Exception $e) {
            Log::error('Availability check failed: ' . $e->getMessage());

            return response()->json([
                'available' => false,
                'message' => __('halls.checking_availability')
            ], 500);
        }
    }


    /**
     * Download booking PDF
     */
    public function downloadPdf(Booking $booking)
    {
        // Ensure user owns this booking
        if ($booking->user_id !== Auth::id()) {
            abort(403);
        }

        $pdfService = app(BookingPdfService::class);
        return $pdfService->downloadWithArabicSupport($booking);
    }

    /**
     * Show booking cancellation page
     *
     * @param Booking $booking
     * @return \Illuminate\View\View
     */
    public function cancelled(Booking $booking)
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Ensure user owns this booking (skip for guest bookings)
        if ($booking->user_id && $booking->user_id !== Auth::id()) {
            abort(403);
        }

        Log::info('Showing booking cancellation page', [
            'booking_id' => $booking->id,
            'booking_number' => $booking->booking_number,
        ]);

        return view('customer.booking-cancelled', compact('booking'));
    }

    /**
     * Retry payment for a booking
     *
     * @param Booking $booking
     * @return \Illuminate\Http\RedirectResponse
     */
    public function retryPayment(Booking $booking)
    {
        $locale = request()->get('lang', session('locale', 'ar'));
        app()->setLocale($locale);

        // Ensure user owns this booking (skip for guest bookings)
        if ($booking->user_id && $booking->user_id !== Auth::id()) {
            abort(403);
        }

        Log::info('Retrying payment for booking', [
            'booking_id' => $booking->id,
            'booking_number' => $booking->booking_number,
        ]);

        // Check if booking is already paid
        if ($booking->payment_status === 'paid') {
            return redirect()
                ->route('customer.booking.success', ['bookingNumber' => $booking->booking_number, 'lang' => $locale])
                ->with('info', __('halls.booking_already_paid'));
        }

        // ✅ FIX: Get the latest payment using direct query (latestPayment relationship not defined)
        $payment = Payment::where('booking_id', $booking->id)->latest()->first();

        if (!$payment) {
            return redirect()
                ->route('customer.halls.index', ['lang' => $locale])
                ->with('error', __('halls.payment_not_found'));
        }

        // If payment is already processing, redirect to gateway
        if ($payment->payment_url && $payment->isProcessing()) {
            return redirect($payment->payment_url);
        }

        // Otherwise, create a new payment session
        try {
            $paymentService = app(\App\Services\PaymentService::class);
            $result = $paymentService->initiatePayment($booking, 'online');

            if ($result['success'] && isset($result['redirect_url'])) {
                Log::info('Payment retry successful, redirecting to gateway', [
                    'booking_id' => $booking->id,
                    'redirect_url' => $result['redirect_url'],
                ]);

                return redirect($result['redirect_url']);
            }

            throw new \Exception($result['message'] ?? 'Failed to initiate payment');
        } catch (\Exception $e) {
            Log::error('Payment retry failed', [
                'booking_id' => $booking->id,
                'error' => $e->getMessage(),
            ]);

            return redirect()
                ->route('customer.booking.cancelled', ['booking' => $booking->id, 'lang' => $locale])
                ->with('error', __('halls.payment_retry_failed') . ': ' . $e->getMessage());
        }
    }
}
